<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Time-based One-Time Password authentication with backup codes</title>

    <link
      rel="icon"
      href="https://twilio-labs.github.io/function-templates/static/v1/favicon.ico"
    />
    <link
      rel="stylesheet"
      href="https://twilio-labs.github.io/function-templates/static/v1/ce-paste-theme.css"
    />
    <script src="/qrcode.min.js"></script>
    <style>
      main {
        padding-top: 40px;
        display: flex;
        flex-direction: column;
        flex: 1;
        justify-content: flex-start;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
      }

      div.content {
        max-width: 100%;
      }

      input[type="submit"] {
        font: inherit;
        border: 1px solid rgb(136, 145, 170);
        border-radius: 4px;
      }

      .explainer {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
        padding: 0.75rem 1.25rem;
        margin-top: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
      }

      .reset {
        margin-top: 1rem;
      }

      #secret {
        font-weight: bold;
        text-transform: uppercase;
      }

      #backup-codes {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="page-top">
      <header>
        <div id="twilio-logo">
          <a href="https://www.twilio.com/" target="_blank" rel="noopener">
            <svg
              class="logo"
              data-name="Layer 1"
              xmlns="http://www.w3.org/2000/svg"
              viewbox="0 0 60 60"
            >
              <title>Twilio Logo</title>
              <path
                class="cls-1"
                d="M30,15A15,15,0,1,0,45,30,15,15,0,0,0,30,15Zm0,26A11,11,0,1,1,41,30,11,11,0,0,1,30,41Zm6.8-14.7a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,26.3Zm0,7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,33.7Zm-7.4,0a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,33.7Zm0-7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,26.3Z"
              />
            </svg>
          </a>
        </div>
        <nav>
          <a href="/index.html" style="text-decoration: none; color: white"
            ><span>Your Twilio Verify Application</span>
            <aside>
              <svg
                class="icon"
                role="img"
                aria-hidden="true"
                width="100%"
                height="100%"
                viewBox="0 0 20 20"
                aria-labelledby="NewIcon-1577"
              >
                <path
                  fill="currentColor"
                  fill-rule="evenodd"
                  d="M6.991 7.507c.003-.679 1.021-.675 1.019.004-.012 2.956 1.388 4.41 4.492 4.48.673.016.66 1.021-.013 1.019-2.898-.011-4.327 1.446-4.48 4.506-.033.658-1.01.639-1.018-.02-.03-3.027-1.382-4.49-4.481-4.486-.675 0-.682-1.009-.008-1.019 3.02-.042 4.478-1.452 4.49-4.484zm.505 2.757l-.115.242c-.459.9-1.166 1.558-2.115 1.976l.176.08c.973.465 1.664 1.211 2.083 2.22l.02.05.088-.192c.464-.973 1.173-1.685 2.123-2.124l.039-.018-.118-.05c-.963-.435-1.667-1.117-2.113-2.034l-.068-.15zm10.357-8.12c.174.17.194.434.058.625l-.058.068-1.954 1.905 1.954 1.908a.482.482 0 010 .694.512.512 0 01-.641.056l-.07-.056-1.954-1.908-1.954 1.908a.511.511 0 01-.71 0 .482.482 0 01-.058-.626l.058-.068 1.954-1.908-1.954-1.905a.482.482 0 010-.693.512.512 0 01.64-.057l.07.057 1.954 1.905 1.954-1.905a.511.511 0 01.71 0z"
                ></path>
              </svg>
              Live
            </aside>
          </a>
        </nav>
      </header>
    </div>
    <main>
      <div class="content">
        <section>
          <p>
            This demo of the
            <a href="https://www.twilio.com/docs/verify/api">
              Twilio Verify API</a
            >
            shows how to set up two-factor authentication (2FA) with a
            third-party authenticator app like
            <a href="https://authy.com/download/">Authy</a> or Google
            Authenticator using the
            <a href="https://www.twilio.com/docs/glossary/totp"
              >time-based one-time password (TOTP)</a
            >
            standard.
          </p>
          <hr />
          <form id="create-factor">
            <div>
              <label for="name">Enter your username:</label>
            </div>
            <div>
              <input type="text" id="name" class="form-control" required />
              <input type="submit" value="Set up two-factor authentication" />
            </div>
          </form>
          <div>
            <span id="status"></span>
          </div>
          <div id="factor-setup" style="display: none">
            <canvas id="canvas"></canvas>
            <div>
              <p>Or enter this code into your authentication app:</p>
              <span id="secret"></span>
            </div>
          </div>
          <div id="backup" style="display: none">
            <div>
              <p>
                <strong>Backup codes</strong>
              </p>
              <p>
                Important! Print or save these codes in a safe place to prevent
                account lockout.
              </p>
              <ul id="backup-codes"></ul>
            </div>
          </div>
          <form id="start-challenge" style="display: none">
            <div>
              <input type="submit" value="Validate authenticator app token" />
            </div>
          </form>
          <form id="otp" style="display: none">
            <div>
              <label for="code"
                >Enter the code generated by your authenticator app:</label
              >
            </div>
            <div>
              <input type="text" id="code" placeholder="456789" required />
              <input type="submit" value="Verify" />
            </div>
          </form>
        </section>
        <section>
          <div class="explainer" id="ex-new-factor">
            <h4>Create a New Factor | What's happening here:</h4>
            <p>
              The API is
              <strong
                >creating a new TOTP
                <a
                  href="https://www.twilio.com/docs/verify/api/factor#create-a-new-factor-resource"
                  >Factor</a
                ></strong
              >
              when you click "Set up two-factor authentication". This is how the
              Verify API connects a user (
              <code>identity</code>
              ), the
              <a href="https://www.twilio.com/docs/glossary/totp"
                >TOTP channel</a
              >, and your app. Each Factor returns the secret seed and URI used
              to create a QR code.
            </p>
            <p>
              For this demo, we're asking for a username that will be displayed
              in the account name for the authenticator app.
            </p>
          </div>
          <div class="explainer" id="ex-verify-factor">
            <h4>Verify a Factor | What's happening here:</h4>
            <p>
              Before you can use this channel for ongoing authentication, the
              user must <strong>verify the Factor</strong> to ensure that setup
              was successful.
            </p>
            <p>
              After sharing the seed via a QR code or secret key,
              <a href="https://www.twilio.com/docs/glossary/totp"
                >this authentication channel is available offline.</a
              >
            </p>
            <p>
              Note: unverified Factors will be deleted between 1 and 24 hours
              after being created.
            </p>
          </div>
          <div class="explainer" id="ex-backup-codes">
            <h4>Backup Codes | What's happening here:</h4>
            <p>
              Backup codes are commonly used as an
              <strong>account recovery factor</strong> in combination with TOTP.
              We generate them for the user here after the TOTP Factor is
              verified. That way, if the user loses access to their
              authenticator app, they have a trusted fallback option for
              authentication.
            </p>
            <p>
              Backup codes are another
              <a href="https://www.twilio.com/docs/glossary/totp"
                >feature of the Twilio Verify API.</a
              >
            </p>
            <p>
              Alternatively, you could register another channel like SMS for
              backup.
            </p>
          </div>
          <div class="explainer" id="ex-ongoing-auth">
            <h4>Ongoing Authentication | What's happening here:</h4>
            <p>
              After the Factor has been verified you can collect a token from
              the user at any time for <strong>ongoing authentication</strong>.
              On the backend, this will
              <a
                href="https://www.twilio.com/docs/verify/api/challenge?code-sample=code-create-totp-challenge-with-authpayload&code-language=Node.js&code-sdk-version=3.x"
                >create a challenge</a
              >
              with the token provided.
            </p>
          </div>
        </section>
        <section>
          <div class="reset">
            <span>
              <a href="#" onclick="window.location.reload(false);">Reset</a>
            </span>
          </div>
        </section>
      </div>
      <!-- EDIT_CODE_V2 -->
    </main>
    <footer>
      <span>We can't wait to see what you build.</span>
    </footer>
  </body>
  <script>
    function hide(element) {
      element.style.display = "none";
    }

    function hideExplainers() {
      Array.from(document.getElementsByClassName("explainer")).forEach(
        (explainer) => {
          hide(explainer);
        }
      );
    }

    function showExplainer(name) {
      hideExplainers();
      document.getElementById(name).style.display = "block";
    }

    function clearStatus() {
      hideExplainers();
      hide(document.getElementById("backup"));
      document.getElementById("status").textContent = "";
    }

    function showStatus(message, color = "gray") {
      clearStatus();
      let status = document.getElementById("status");
      status.style.color = color;
      status.textContent = message;
    }

    function showError(error) {
      console.error(error);
      showStatus(error, (color = "#a94442"));
    }

    function showQRCode(uri, secret) {
      document.getElementById("factor-setup").style.display = "flex";
      showExplainer("ex-verify-factor");
      document.getElementById("secret").innerHTML = secret;
      QRCode.toCanvas(document.getElementById("canvas"), uri, function (error) {
        if (error) showError(error);
        showOtpForm(verifyFactor);
      });
    }

    function showOtpForm(submitFn) {
      const otp = document.getElementById("otp");
      otp.addEventListener("submit", submitFn);
      otp.style.display = "block";
      hide(document.getElementById("create-factor"));
    }

    function hideOtpForm() {
      const otp = document.getElementById("otp");
      otp.removeEventListener("submit", verifyFactor);
      otp.removeEventListener("submit", checkToken);
      hide(otp);
    }

    function showBackupCodes(backupCodes) {
      showExplainer("ex-backup-codes");
      document.getElementById("backup").style.display = "block";
      const codeList = document.getElementById("backup-codes");
      backupCodes.forEach((code) => {
        var li = document.createElement("li");
        li.appendChild(document.createTextNode(code));
        codeList.appendChild(li);
      });
    }

    var identity;
    var factorSid;

    function createFactor(event) {
      event.preventDefault();
      showStatus("Creating a QR code...");

      const data = new URLSearchParams();
      data.append("identity", identity);
      data.append("name", document.getElementById("name").value);

      fetch("./create-factor", {
        method: "POST",
        body: data,
      })
        .then((response) => {
          if (response.status >= 400) {
            hideOtpForm();
            document.getElementById("create-factor").style.display = "flex";

            return response.json().then(({ message }) => {
              showError(message);
            });
          } else {
            return response.json().then((json) => {
              if (json.ok) {
                identity = json.identity;
                factorSid = json.factorSid;
                console.log(
                  `Created TOTP factor '${factorSid}' for identity ${identity}`
                );

                showStatus(json.message);
                showQRCode(json.uri, json.secret);
              } else {
                showError(json.message);
              }
            });
          }
        })
        .catch(() => {
          showError(`Something went wrong.`);
        });
    }

    function parseTokenData() {
      event.preventDefault();
      const code = document.getElementById("code").value;
      showStatus(`Checking code ${code}...`);

      const data = new URLSearchParams();
      data.append("identity", identity);
      data.append("factorSid", factorSid);
      data.append("code", code);
      return data;
    }

    function verifyFactor(event) {
      const data = parseTokenData();

      fetch("./verify-new-factor", {
        method: "POST",
        body: data,
      })
        .then((response) => {
          return response.json();
        })
        .then((json) => {
          if (json.ok) {
            showStatus(json.message, (color = "#3c763d"));

            hideOtpForm();
            hide(document.getElementById("factor-setup"));

            showBackupCodes(json.backupCodes);
            document.getElementById("start-challenge").style.display = "flex";
          } else {
            showError(json.message);
          }
          document.getElementById("code").value = "";
        })
        .catch((error) => {
          showError(error);
        });
    }

    function checkToken(event) {
      const data = parseTokenData();

      fetch("./check-token", {
        method: "POST",
        body: data,
      })
        .then((response) => {
          return response.json();
        })
        .then((json) => {
          if (json.ok) {
            clearStatus();
            hideOtpForm();
            showStatus(json.message, (color = "#3c763d"));
            document.getElementById("start-challenge").style.display = "flex";
          } else {
            showError(json.message);
          }
          document.getElementById("code").value = "";
        })
        .catch((error) => {
          showError(error);
        });
    }

    function startChallenge(event) {
      event.preventDefault();
      hide(document.getElementById("start-challenge"));
      clearStatus();
      showExplainer("ex-ongoing-auth");
      showOtpForm(checkToken);
    }

    showExplainer("ex-new-factor");
    document
      .getElementById("create-factor")
      .addEventListener("submit", createFactor);
    document
      .getElementById("start-challenge")
      .addEventListener("submit", startChallenge);
  </script>
</html>
